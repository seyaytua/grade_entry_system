name: Windowsé…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•ãƒ“ãƒ«ãƒ‰ & ãƒªãƒªãƒ¼ã‚¹

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

jobs:
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ãƒ“ãƒ«ãƒ‰å‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        python test_before_build.py || true  # GUIé–¢é€£ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–

    - name: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
      run: |
        python -c "
        import sys
        sys.path.append('.')
        try:
            import database
            import models  
            import views
            import utils
            import config
            print('âœ… ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«æˆåŠŸ')
        except Exception as e:
            print(f'âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
            sys.exit(1)
        "

  build-windows:
    name: Windowså®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãƒ“ãƒ«ãƒ‰
    needs: test
    runs-on: windows-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Windowsç”¨å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        python build_windows.py

    - name: ãƒ“ãƒ«ãƒ‰çµæžœç¢ºèª
      run: |
        if (Test-Path "dist\GradeEntrySystem\GradeEntrySystem.exe") {
          Write-Host "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ: GradeEntrySystem.exe ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          $size = (Get-Item "dist\GradeEntrySystem\GradeEntrySystem.exe").Length
          Write-Host "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $($size / 1MB) MB"
        } else {
          Write-Host "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—: å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          exit 1
        }

    - name: é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã§åœ§ç¸®
      run: |
        $version = if ($env:GITHUB_REF -match "refs/tags/(.*)") { $matches[1] } else { "latest" }
        $zipName = "GradeEntrySystem-Windows-$version.zip"
        Compress-Archive -Path "dist\GradeEntrySystem\*" -DestinationPath $zipName
        Write-Host "ðŸ“¦ é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ: $zipName"
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_ENV

    - name: é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: windows-distribution
        path: ${{ env.ZIP_NAME }}
        retention-days: 30

    - name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆ (ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ZIP_NAME }}
        name: æˆç¸¾å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ  ${{ env.VERSION }}
        body: |
          ## ðŸŽ¯ æˆç¸¾å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ  ${{ env.VERSION }}
          
          Windowsç”¨é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
          
          ### ðŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          
          1. **GradeEntrySystem-Windows-${{ env.VERSION }}.zip** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«è§£å‡
          3. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€å†…ã® **GradeEntrySystem.exe** ã‚’å®Ÿè¡Œ
          
          ### âš ï¸ åˆå›žå®Ÿè¡Œæ™‚ã®æ³¨æ„äº‹é …
          
          - Windows Defenderã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
          - ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„
          - ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŽ¨å¥¨ã—ã¾ã™
          
          ### ðŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          
          - Windows 10 ä»¥ä¸Š
          - Microsoft Visual C++ å†é ’å¸ƒå¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (é€šå¸¸ã¯è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿)
          
          ### ðŸ“ ä¸»ãªæ©Ÿèƒ½
          
          - æˆç¸¾å…¥åŠ›ï¼ˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ãï¼‰
          - è¬›åº§ç®¡ç†
          - ç”Ÿå¾’åç°¿ç®¡ç†  
          - æˆç¸¾ä¸€è¦§è¡¨ç¤ºãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          - PDFåˆ†å‰²æ©Ÿèƒ½
          
          ### ðŸ†˜ ã‚µãƒãƒ¼ãƒˆ
          
          å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€Issuesãƒšãƒ¼ã‚¸ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-info:
    name: ãƒ“ãƒ«ãƒ‰æƒ…å ±è¡¨ç¤º
    needs: [test, build-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ãƒ“ãƒ«ãƒ‰çµæžœã‚µãƒžãƒªãƒ¼
      run: |
        echo "## ðŸ”¨ ãƒ“ãƒ«ãƒ‰çµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "âœ… **ãƒ†ã‚¹ãƒˆ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ãƒ†ã‚¹ãƒˆ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.build-windows.result }}" == "success" ]; then
          echo "âœ… **Windows ãƒ“ãƒ«ãƒ‰**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "- Windowsç”¨å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆZIPå½¢å¼ï¼‰ãŒArtifactsã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "- ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã«è‡ªå‹•çš„ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
        elif [ "${{ needs.build-windows.result }}" == "skipped" ]; then
          echo "â­ï¸ **Windows ãƒ“ãƒ«ãƒ‰**: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆéžmainãƒ–ãƒ©ãƒ³ãƒï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Windows ãƒ“ãƒ«ãƒ‰**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "- é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
        echo "- å•é¡ŒãŒãªã‘ã‚Œã°ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼ˆä¾‹: \`git tag v1.0.0 && git push origin v1.0.0\`ï¼‰" >> $GITHUB_STEP_SUMMARY