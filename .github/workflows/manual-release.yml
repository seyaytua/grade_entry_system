name: æ‰‹å‹•ãƒªãƒªãƒ¼ã‚¹ä½œæˆ

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆ'
        required: false
        type: string
        default: ''
      prerelease:
        description: 'ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹ã¨ã—ã¦ãƒãƒ¼ã‚¯'
        required: false
        type: boolean
        default: false

jobs:
  validate-version:
    name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œè¨¼
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      is_valid: ${{ steps.validate.outputs.is_valid }}
    
    steps:
    - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ã‚’æ¤œè¨¼
      id: validate
      run: |
        VERSION="${{ github.event.inputs.version }}"
        
        # væ¥é ­è¾ã‚’è¿½åŠ ï¼ˆãªã„å ´åˆï¼‰
        if [[ ! "$VERSION" =~ ^v ]]; then
          VERSION="v$VERSION"
        fi
        
        # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
        if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "is_valid=true" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ãŒæ­£ã—ã„ã§ã™: $VERSION"
        else
          echo "is_valid=false" >> $GITHUB_OUTPUT
          echo "âŒ ãƒãƒ¼ã‚¸ãƒ§ãƒ³å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: $VERSION"
          echo "æ­£ã—ã„å½¢å¼: v1.0.0, v1.2.3-beta ãªã©"
          exit 1
        fi

  build-and-release:
    name: ãƒ“ãƒ«ãƒ‰ & ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    needs: validate-version
    runs-on: windows-latest
    if: needs.validate-version.outputs.is_valid == 'true'
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: ãƒªãƒªãƒ¼ã‚¹ç”¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      run: |
        echo "ğŸ”¨ ãƒªãƒªãƒ¼ã‚¹ ${{ needs.validate-version.outputs.version }} ç”¨ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹"
        python build_windows.py

    - name: ãƒ“ãƒ«ãƒ‰çµæœæ¤œè¨¼
      run: |
        if (Test-Path "dist\GradeEntrySystem\GradeEntrySystem.exe") {
          $size = (Get-Item "dist\GradeEntrySystem\GradeEntrySystem.exe").Length
          Write-Host "âœ… ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰æˆåŠŸ"
          Write-Host "ğŸ“ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round($size / 1MB, 2)) MB"
          
          # ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          $buildInfo = @{
            version = "${{ needs.validate-version.outputs.version }}"
            build_date = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            file_size_mb = [math]::Round($size / 1MB, 2)
            python_version = (python --version)
          } | ConvertTo-Json
          
          $buildInfo | Out-File -FilePath "dist\GradeEntrySystem\build-info.json" -Encoding UTF8
          Write-Host "ğŸ“„ ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
        } else {
          Write-Host "âŒ ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å¤±æ•—"
          exit 1
        }

    - name: ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
      run: |
        $VERSION = "${{ needs.validate-version.outputs.version }}"
        $ZIP_NAME = "GradeEntrySystem-Windows-$VERSION.zip"
        
        # é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ã«READMEã‚’è¿½åŠ 
        Copy-Item "README.md" "dist\GradeEntrySystem\"
        Copy-Item "WINDOWS_BUILD_GUIDE.md" "dist\GradeEntrySystem\"
        
        # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°è¿½åŠ 
        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" "dist\GradeEntrySystem\"
        }
        
        # ZIPãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        Compress-Archive -Path "dist\GradeEntrySystem\*" -DestinationPath $ZIP_NAME -Force
        
        $zipSize = (Get-Item $ZIP_NAME).Length
        Write-Host "ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†: $ZIP_NAME"
        Write-Host "ğŸ“ ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round($zipSize / 1MB, 2)) MB"
        
        echo "ZIP_NAME=$ZIP_NAME" >> $env:GITHUB_ENV

    - name: ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æº–å‚™
      run: |
        $VERSION = "${{ needs.validate-version.outputs.version }}"
        $CUSTOM_NOTES = "${{ github.event.inputs.release_notes }}"
        
        $releaseNotes = @"
## ğŸ¯ æˆç¸¾å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ  $VERSION

Windowsç”¨é…å¸ƒãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

1. **${{ env.ZIP_NAME }}** ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
2. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«è§£å‡  
3. è§£å‡ã—ãŸãƒ•ã‚©ãƒ«ãƒ€å†…ã® **GradeEntrySystem.exe** ã‚’å®Ÿè¡Œ

### âš ï¸ åˆå›å®Ÿè¡Œæ™‚ã®æ³¨æ„äº‹é …

- Windows Defenderã®è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
- ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„
- ç®¡ç†è€…ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™

### ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

- Windows 10 ä»¥ä¸Š
- Microsoft Visual C++ å†é ’å¸ƒå¯èƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ (é€šå¸¸ã¯è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿)

### ğŸ“ ä¸»ãªæ©Ÿèƒ½

- ğŸ“Š æˆç¸¾å…¥åŠ›ï¼ˆç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä»˜ãï¼‰
- ğŸ“š è¬›åº§ç®¡ç†
- ğŸ‘¥ ç”Ÿå¾’åç°¿ç®¡ç†
- ğŸ“ˆ æˆç¸¾ä¸€è¦§è¡¨ç¤ºãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- ğŸ“„ PDFåˆ†å‰²æ©Ÿèƒ½
"@

        if ($CUSTOM_NOTES -ne "") {
          $releaseNotes += @"


### ğŸ†• ã“ã®ãƒªãƒªãƒ¼ã‚¹ã§ã®å¤‰æ›´ç‚¹

$CUSTOM_NOTES
"@
        }

        $releaseNotes += @"


### ğŸ†˜ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€[Issuesãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/issues)ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

---

**ãƒ“ãƒ«ãƒ‰æƒ…å ±**
- ãƒ“ãƒ«ãƒ‰æ—¥æ™‚: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $(python --version)
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round((Get-Item '${{ env.ZIP_NAME }}').Length / 1MB, 2)) MB
"@
        
        # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        $releaseNotes | Out-File -FilePath "release-notes.md" -Encoding UTF8
        Write-Host "ğŸ“ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’æº–å‚™ã—ã¾ã—ãŸ"

    - name: Gitã‚¿ã‚°ã‚’ä½œæˆ
      run: |
        $VERSION = "${{ needs.validate-version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # ã‚¿ã‚°ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        git tag -l $VERSION
        if ($LASTEXITCODE -eq 0) {
          Write-Host "âš ï¸ ã‚¿ã‚° $VERSION ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
        } else {
          git tag -a $VERSION -m "Release $VERSION"
          git push origin $VERSION
          Write-Host "âœ… ã‚¿ã‚° $VERSION ã‚’ä½œæˆã—ã¾ã—ãŸ"
        }

    - name: GitHub ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate-version.outputs.version }}
        name: æˆç¸¾å…¥åŠ›ã‚·ã‚¹ãƒ†ãƒ  ${{ needs.validate-version.outputs.version }}
        body_path: release-notes.md
        files: ${{ env.ZIP_NAME }}
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
      run: |
        $VERSION = "${{ needs.validate-version.outputs.version }}"
        Write-Host ""
        Write-Host "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ $VERSION ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
        Write-Host ""
        Write-Host "ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±:"
        Write-Host "  - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $VERSION"
        Write-Host "  - ãƒ•ã‚¡ã‚¤ãƒ«: ${{ env.ZIP_NAME }}"
        Write-Host "  - ãƒ—ãƒ¬ãƒªãƒªãƒ¼ã‚¹: ${{ github.event.inputs.prerelease }}"
        Write-Host ""
        Write-Host "ğŸ”— ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸:"
        Write-Host "  https://github.com/${{ github.repository }}/releases/tag/$VERSION"
        Write-Host ""
        Write-Host "ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL:"
        Write-Host "  https://github.com/${{ github.repository }}/releases/download/$VERSION/${{ env.ZIP_NAME }}"