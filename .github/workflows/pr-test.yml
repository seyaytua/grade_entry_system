name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªå‹•ãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  lint-and-test:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ & ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort

    - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ (Black)
      run: |
        black --check --diff . || echo "âš ï¸ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚'black .' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

    - name: ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºãƒã‚§ãƒƒã‚¯ (isort)
      run: |
        isort --check-only --diff . || echo "âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆé †åºã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚'isort .' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"

    - name: æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ (flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
      run: |
        python -c "
        import sys
        sys.path.append('.')
        
        modules_to_test = [
            'database',
            'database.db_manager',
            'models.course',
            'models.student', 
            'models.grade',
            'utils.csv_handler',
            'utils.radio_button_helper',
            'config.settings',
        ]
        
        failed = []
        for module in modules_to_test:
            try:
                __import__(module)
                print(f'âœ… {module}')
            except Exception as e:
                print(f'âŒ {module}: {e}')
                failed.append(module)
        
        if failed:
            print(f'\\nå¤±æ•—ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ•°: {len(failed)}')
            sys.exit(1)
        else:
            print(f'\\nâœ… å…¨ {len(modules_to_test)} ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«æˆåŠŸ')
        "

    - name: PySide6åŸºæœ¬ãƒ†ã‚¹ãƒˆ
      run: |
        python -c "
        try:
            from PySide6.QtWidgets import QApplication
            from PySide6.QtCore import QTimer
            print('âœ… PySide6ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ')
        except ImportError as e:
            print(f'âŒ PySide6ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: {e}')
            exit(1)
        except Exception as e:
            print(f'âš ï¸ PySide6ãƒ†ã‚¹ãƒˆè­¦å‘Š: {e} (ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ç’°å¢ƒã§ã¯æ­£å¸¸)')
        "

  windows-build-test:
    name: Windows ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: windows-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: PyInstallerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ (dry-run)
      run: |
        echo "PyInstallerè¨­å®šãƒã‚§ãƒƒã‚¯ä¸­..."
        pyinstaller --noconfirm --log-level=DEBUG grade_entry_system.spec --distpath test_dist --workpath test_build

    - name: ãƒ“ãƒ«ãƒ‰çµæœç¢ºèª
      run: |
        if (Test-Path "test_dist\GradeEntrySystem\GradeEntrySystem.exe") {
          Write-Host "âœ… Windows ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆæˆåŠŸ"
          $size = (Get-Item "test_dist\GradeEntrySystem\GradeEntrySystem.exe").Length
          Write-Host "ğŸ“ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round($size / 1MB, 2)) MB"
        } else {
          Write-Host "âŒ Windows ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—"
          exit 1
        }

  comment-results:
    name: ãƒ†ã‚¹ãƒˆçµæœã‚³ãƒ¡ãƒ³ãƒˆ
    needs: [lint-and-test, windows-build-test]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    
    steps:
    - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
      uses: actions/github-script@v6
      with:
        script: |
          const lintResult = '${{ needs.lint-and-test.result }}';
          const buildResult = '${{ needs.windows-build-test.result }}';
          
          let comment = '## ğŸ” ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆè‡ªå‹•ãƒ†ã‚¹ãƒˆçµæœ\n\n';
          
          // ãƒ†ã‚¹ãƒˆçµæœ
          comment += '### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ\n';
          comment += `- **ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯**: ${lintResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n`;
          comment += `- **Windowsãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ**: ${buildResult === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n\n`;
          
          // è©³ç´°æƒ…å ±
          if (lintResult === 'success' && buildResult === 'success') {
            comment += '### âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼\n';
            comment += 'ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®‰å…¨ã«ãƒãƒ¼ã‚¸ã§ãã¾ã™ã€‚\n\n';
            comment += '#### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—\n';
            comment += '1. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½\n';
            comment += '2. å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸\n';
            comment += '3. ãƒãƒ¼ã‚¸å¾Œã€mainãƒ–ãƒ©ãƒ³ãƒã§è‡ªå‹•ãƒ“ãƒ«ãƒ‰ & ãƒªãƒªãƒ¼ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¾ã™\n';
          } else {
            comment += '### âš ï¸ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ\n';
            comment += 'è©³ç´°ã¯ä¸Šè¨˜ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n';
            comment += '#### ä¿®æ­£ãŒå¿…è¦ãªé …ç›®\n';
            if (lintResult !== 'success') {
              comment += '- ã‚³ãƒ¼ãƒ‰å“è³ªã®å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„\n';
            }
            if (buildResult !== 'success') {
              comment += '- Windowsãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„\n';
            }
          }
          
          comment += '\n---\n*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });