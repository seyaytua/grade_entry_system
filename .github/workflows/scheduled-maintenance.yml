name: å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ & ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 (JST) ã«å®Ÿè¡Œ
    - cron: '0 0 * * MON'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

jobs:
  dependency-check:
    name: ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety bandit

    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ (Safety)
      run: |
        safety check --json --output safety-report.json || true
        if [ -f safety-report.json ]; then
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ"
        fi

    - name: ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æ (Bandit)
      run: |
        bandit -r . -f json -o bandit-report.json || true
        if [ -f bandit-report.json ]; then
          echo "ğŸ” ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ"
        fi

    - name: ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãƒã‚§ãƒƒã‚¯
      run: |
        pip list --outdated --format=json > outdated-packages.json
        if [ -s outdated-packages.json ] && [ "$(cat outdated-packages.json)" != "[]" ]; then
          echo "ğŸ“¦ æ›´æ–°å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          cat outdated-packages.json
        else
          echo "âœ… ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæœ€æ–°ã§ã™"
        fi

    - name: ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json
          outdated-packages.json
        retention-days: 30

  build-health-check:
    name: ãƒ“ãƒ«ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: windows-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: å®šæœŸãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
      run: |
        python build_windows.py

    - name: ãƒ“ãƒ«ãƒ‰æˆåŠŸç¢ºèª
      run: |
        if (Test-Path "dist\GradeEntrySystem\GradeEntrySystem.exe") {
          $size = (Get-Item "dist\GradeEntrySystem\GradeEntrySystem.exe").Length
          Write-Host "âœ… å®šæœŸãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆæˆåŠŸ"
          Write-Host "ğŸ“ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $([math]::Round($size / 1MB, 2)) MB"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å¤‰åŒ–ã‚’ãƒã‚§ãƒƒã‚¯
          $sizeMB = [math]::Round($size / 1MB, 2)
          if ($sizeMB -gt 200) {
            Write-Host "âš ï¸ å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãããªã£ã¦ã„ã¾ã™ ($sizeMB MB)"
          }
        } else {
          Write-Host "âŒ å®šæœŸãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå¤±æ•—"
          exit 1
        }

  create-maintenance-report:
    name: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
    needs: [dependency-check, build-health-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
      run: |
        echo "# ğŸ“Š å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ" > maintenance-report.md
        echo "" >> maintenance-report.md
        echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> maintenance-report.md
        echo "" >> maintenance-report.md
        
        echo "## ğŸ” ãƒã‚§ãƒƒã‚¯çµæœ" >> maintenance-report.md
        echo "" >> maintenance-report.md
        
        if [ "${{ needs.dependency-check.result }}" == "success" ]; then
          echo "âœ… **ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**: æ­£å¸¸" >> maintenance-report.md
        else
          echo "âŒ **ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**: å•é¡Œã‚ã‚Š" >> maintenance-report.md
        fi
        
        if [ "${{ needs.build-health-check.result }}" == "success" ]; then
          echo "âœ… **ãƒ“ãƒ«ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: æ­£å¸¸" >> maintenance-report.md
        else
          echo "âŒ **ãƒ“ãƒ«ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: å•é¡Œã‚ã‚Š" >> maintenance-report.md
        fi
        
        echo "" >> maintenance-report.md
        echo "## ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" >> maintenance-report.md
        echo "" >> maintenance-report.md
        
        if [ "${{ needs.dependency-check.result }}" != "success" ] || [ "${{ needs.build-health-check.result }}" != "success" ]; then
          echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> maintenance-report.md
          echo "- å¿…è¦ã«å¿œã˜ã¦ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°ã—ã¦ãã ã•ã„" >> maintenance-report.md
          echo "- ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ä¿®æ­£ã—ã¦ãã ã•ã„" >> maintenance-report.md
        else
          echo "- ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ" >> maintenance-report.md
          echo "- ç‰¹ã«å¯¾å‡¦ãŒå¿…è¦ãªå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“" >> maintenance-report.md
        fi
        
        echo "" >> maintenance-report.md
        echo "---" >> maintenance-report.md
        echo "*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*" >> maintenance-report.md

    - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v3
      with:
        name: maintenance-report
        path: maintenance-report.md
        retention-days: 90

    - name: å•é¡ŒãŒã‚ã‚Œã°Issueä½œæˆ
      if: needs.dependency-check.result != 'success' || needs.build-health-check.result != 'success'
      uses: actions/github-script@v6
      with:
        script: |
          const title = `ğŸš¨ å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹: å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ (${new Date().toISOString().split('T')[0]})`;
          
          let body = `## ğŸ“Š å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n`;
          body += `**æ¤œå‡ºæ—¥æ™‚**: ${new Date().toISOString()}\n\n`;
          
          body += `### ğŸ” ãƒã‚§ãƒƒã‚¯çµæœ\n\n`;
          body += `- **ä¾å­˜é–¢ä¿‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**: ${'${{ needs.dependency-check.result }}' === 'success' ? 'âœ… æ­£å¸¸' : 'âŒ å•é¡Œã‚ã‚Š'}\n`;
          body += `- **ãƒ“ãƒ«ãƒ‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**: ${'${{ needs.build-health-check.result }}' === 'success' ? 'âœ… æ­£å¸¸' : 'âŒ å•é¡Œã‚ã‚Š'}\n\n`;
          
          body += `### ğŸ“‹ å¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n\n`;
          if ('${{ needs.dependency-check.result }}' !== 'success') {
            body += `- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèª\n`;
            body += `- [ ] è„†å¼±ãªä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°\n`;
          }
          if ('${{ needs.build-health-check.result }}' !== 'success') {
            body += `- [ ] ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’èª¿æŸ»ãƒ»ä¿®æ­£\n`;
          }
          
          body += `\n### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯\n\n`;
          body += `- [ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ­ã‚°](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
          body += `- [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ](${context.payload.repository.html_url}/actions/runs/${context.runId})\n\n`;
          
          body += `---\n*ã“ã® Issue ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['maintenance', 'automated']
          });